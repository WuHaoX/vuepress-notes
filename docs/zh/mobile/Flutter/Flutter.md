# **Flutter笔记**

## 说明

这是一篇关于Flutter的笔记，出自《Flutter实战*第二版》作者杜文（网名wendux）创作的一本系统介绍Flutter技术的中文书籍。如果有条件可以去作者的[电子版](https://book.flutterchina.club/#%E5%85%B3%E4%BA%8E%E9%9A%8F%E4%B9%A6%E6%BA%90%E7%A0%81)支持一波作者。

笔者只是为了加强知识记忆写下了这篇笔记，笔者本身还是非常的菜。如果你想更好的学习还是建议去读[《Flutter实战*第二版》](https://book.flutterchina.club/#%E5%85%B3%E4%BA%8E%E9%9A%8F%E4%B9%A6%E6%BA%90%E7%A0%81)，毕竟一千个人中就有一千个哈姆雷特。

# **第一章：起步**

## **1.1移动端开发技术简介**

了解以下之前的技术

### **1.1.1原生开发与跨平台技术**

1. **原生开发**

使用相应移动平台支持的开发工具和语言，直接调用系统提供的SDK API。比如Android使用Java或Kotlin语言直接调用Android SDK开发的应用程序；iOS使用Objective-c或Swift语言直接调用iOS SDK开发应用程序。原生开发主要优势：

* 可访问平台的全部功能（GPS等等）；
* 速度块、性能高、可以实现复杂动画及绘制

缺点：

* 平台固定，开发成本高；不同平台必须维护不同代码；
* 内容固定，动态化弱，多数情况下有新功能更新时只能发版；

2. **跨平台技术简介**

跨平台框架，根据原理，主要分为三类：

* H5 + 原生 (Cordova、Ionic、微信小程序)
* Javascript开发 + 原生渲染 (React Native、Weex)
* 自绘UI + 原生 (Qt for mobile、Flutter)

### **1.1.2跨端技术简介**

1. **H5 + 原生**

这类框架主要原理就是将 App 中需要动态变动的内容通过HTML5（简称 H5）来实现，通过原生的网页加载控件WebView （Android）或 WKWebView（iOS）来加载（以后若无特殊说明，我们用WebView来统一指代 Android 和 iOS 中的网页加载控件）。这种方案中，H5 部分是可以随时改变而不用发版，动态化需求能满足；同时，由于 H5 代码只需要一次开发，就能同时在 Android 和 iOS 两个平台运行，这也可以减小开发成本，也就是说，H5 部分功能越多，开发成本就越小。我们称这种 H5 + 原生 的开发模式为混合开发 ，采用混合模式开发的App我们称之为混合应用或 HTMLybrid App ，如果一个应用的大多数功能都是 H5 实现的话，我们称其为 Web App 。

目前国内各家公司小程序应用层的开发技术栈是 Web 技术栈，而底层渲染方式基本都是 WebView 和原生相结合的方式。

2. **混合开发技术点**

原生开发可以访问平台所有功能，而混合开发中，H5代码是运行在 WebView 中，而 WebView 实质上就是一个浏览器内核，其 JavaScript 依然运行在一个权限受限的沙箱中，所以对于大多数系统能力都没有访问权限，如无法访问文件系统、不能使用蓝牙等。所以，对于 H5 不能实现的功能，就需要原生去做了。

混合框架一般都会在原生代码中预先实现一些访问系统能力的 API ， 然后暴露给 WebView 以供 JavaScript 调用。这样一来，WebView 中 JavaScript 与原生 API 之间就需要一个通信的桥梁，主要负责 JavaScript 与原生之间传递调用消息，而消息的传递必须遵守一个标准的协议，它规定了消息的格式与含义，我们把依赖于 WebView 的用于在 JavaScript 与原生之间通信并实现了某种消息传输协议的工具称之为 **WebView JavaScript Bridge** , 简称 **JsBridge**，它也是混合开发框架的核心。

混合应用无非就是在第一步中预先实现一系列 API 供 JavaScript 调用，让 JavaScript 有访问系统功能的能力。

3. **小结**

混合应用的优点是：动态内容可以用 H5开发，而H5是Web 技术栈，Web技术栈生态开放且社区资源丰富，整体开发效率高。缺点是性能体验不佳，对于复杂用户界面或动画，WebView 有时会不堪重任。

## ** 1.1.3 React Native、Weex **

React Native （简称 RN ）是 Facebook 于 2015 年 4 月开源的跨平台移动应用开发框架，RN 使用JSX 语言（扩展后的 JavaScript，主要是可以在 JavaScript 中写 HTML标签）和 CSS 来开发移动应用。

React 是一个响应式的 Web 框架，我们先了解一下两个重要的概念：DOM 树与响应式编程。

1. **DOM树与控件树**

文档对象模型（Document Object Model，简称DOM），是 W3C 组织推荐的处理可扩展标志语言的标准编程接口，一种独立于平台和语言的方式访问和修改一个文档的内容和结构。换句话说，这是表示和处理一个 HTML 或XML 文档的标准接口。简单来说，DOM 就是文档树，与用户界面控件树对应，在前端开发中通常指 HTML 对应的渲染树，但广义的 DOM 也可以指 Android 中的 XML 布局文件对应的控件树，而术语DOM操作就是指直接来操作渲染树（或控件树）， 因此，可以看到其实 DOM 树和控件树是等价的概念，只不过前者常用于 Web 开发中，而后者常用于原生开发中。

2. **响应式编程**

React 中提出一个重要思想：状态改变则UI随之自动改变。而 React 框架本身就是响应用户状态改变的事件而执行重新构建用户界面的工作，这就是典型的 响应式 编程范式，下面我们总结一下 React 中响应式原理：

* 开发者只需关注状态转移（数据），当状态发生变化，React 框架会自动根据新的状态重新构建UI。

* React 框架在接收到用户状态改变通知后，会根据当前渲染树，结合最新的状态改变，通过 Diff 算法，计算出树中变化的部分，然后只更新变化的部分（DOM操作），从而避免整棵树重构，提高性能。

值得注意的是，在第二步中，状态变化后 React 框架并不会立即去计算并渲染 DOM 树的变化部分，相反，React会在 DOM 树的基础上建立一个抽象层，即虚拟DOM树，对数据和状态所做的任何改动，都会被自动且高效的同步到虚拟 DOM ，最后再批量同步到真实 DOM 中，而不是每次改变都去操作一下DOM。

为什么不能每次改变都直接去操作 DOM 树？这是因为在浏览器中每一次 DOM 操作都有可能引起浏览器的重绘或回流（重新排版布局，确定 DOM 节点的大小和位置）：

1. 如果 DOM 只是外观风格发生变化，如颜色变化，会导致浏览器重绘界面。
2. 如果 DOM 树的结构发生变化，如尺寸、布局、节点隐藏等导致，浏览器就需要回流。

而浏览器的重绘和回流都是比较昂贵的操作，如果每一次改变都直接对 DOM 进行操作，这会带来性能问题，而批量操作只会触发一次 DOM 更新，会有更高的性能。

:::tip
思考题：Diff操作和DOM批量更新难道不应该是浏览器的职责吗？第三方框架中去做合不合适？

笔者认为浏览器如果Diff操作和DOM批量更新交给浏览器去做反而限制了开发者，react和vue都是先用虚拟DOM再去操作真实DOM，但细节却不一样。在react中，当状态发生改变时，组件树就会自顶向下的全diff, 重新render页面， 重新生成新的虚拟dom tree， 新旧dom tree进行比较， 进行patch打补丁方式，局部更新dom。vue会跟踪每一个组件的依赖关系，局部渲染组件树而不需要重新渲染整个组件树。
:::

3. **React Native**

上文已经提到 React Native 是 React 在原生移动应用平台的衍生产物，那两者主要的区别是什么呢？其实，主要的区别在于虚拟 DOM 映射的对象是什么。React中虚拟 DOM 最终会映射为**浏览器 DOM 树**，而 RN 中虚拟 DOM会通过 JavaScriptCore 映射为**原生控件**。

JavaScriptCore 是一个JavaScript解释器，它在React Native中主要有两个作用：

1. 为 JavaScript 提供运行环境。
2. 是 JavaScript 与原生应用之间通信的桥梁，作用和 JsBridge 一样，事实上，在 iOS 中，很多 JsBridge 的实现都是基于 JavaScriptCore 。

而 RN 中将虚拟 DOM 映射为原生控件的过程主要分两步：

1. 布局消息传递； 将虚拟 DOM 布局信息传递给原生；
2. 原生根据布局信息通过对应的原生控件渲染；

至此，React Native 便实现了跨平台。 相对于混合应用，由于React Native是 原生控件渲染，所以性能会比混合应用中 H5 好一些，同时 React Native 提供了很多原生组件对应的 Web 组件，大多数情况下开发者只需要使用 Web 技术栈 就能开发出 App